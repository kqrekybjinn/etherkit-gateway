# 工业智能边缘网关演进路线图

本文档旨在规划如何利用 **Arm® Cortex®-R52** 核心及强大的工业外设特性，将当前的 MQTT 演示项目升级为功能完备的**工业智能边缘网关**。

## 1. 硬件特性深度利用分析

基于您提供的硬件规格（推测为 Renesas RZ/N2L 或类似高性能工业 MPU），我们需要在软件架构上充分发挥以下优势：

| 硬件特性 | 边缘网关应用场景 | 建议技术方案 |
| :--- | :--- | :--- |
| **Cortex-R52 @ 400MHz** | 实时控制与高确定性任务调度 | 利用 RT-Thread 的实时调度能力，将关键任务（如运动控制、高频采集）绑定到高优先级。 |
| **ECC 内存 (TCM/RAM)** | 工业级高可靠性数据存储 | 确保关键配置、状态数据和缓存队列存放在 ECC 区域，防止位翻转导致系统崩溃。 |
| **3x 千兆网口 + TSN** | 时间敏感网络与高带宽传输 | 实现 IEEE 802.1AS 时间同步，保证多设备协同；利用 802.1Qbv 进行流量整形，确保控制数据优先传输。 |
| **网络冗余 (DLR, PRP)** | 零丢包高可用网络 | 在双网口上启用 PRP/HSR 或 DLR 协议栈，确保单链路故障时通信不中断。 |
| **EtherCAT 从站控制器** | 接入工业现场总线 | 作为 EtherCAT 从站接入 PLC 网络，同时作为网关采集数据上云。 |
| **CAN (2通道)** | 现场设备接入 | 接入伺服驱动器、传感器或其他 CANopen/J1939 设备。 |
| **UART (6通道)** | 传统设备接入 | 接入 Modbus RTU 仪表、扫码枪、打印机等。 |

---

## 2. 功能模块演进规划

### 2.1 南向接口（数据采集与设备接入）
网关的核心能力是“连接万物”。利用丰富的接口资源，我们需要扩展多种工业协议支持。

*   **Modbus RTU/TCP 主站**
    *   **利用硬件**: UART, Ethernet
    *   **实现**: 集成 `libmodbus` 或 `FreeModbus` 协议栈。
    *   **功能**: 轮询读取温湿度传感器、电表、PLC 寄存器数据。
*   **CAN 总线接入**
    *   **利用硬件**: CAN FD 控制器
    *   **实现**: 使用 RT-Thread CAN 设备驱动框架。
    *   **功能**: 解析 CAN 报文，支持 CANopen 或自定义协议，接入汽车电子或工业伺服。
*   **EtherCAT 从站功能**
    *   **利用硬件**: EtherCAT Slave Controller (ESC)
    *   **实现**: 移植 EtherCAT 从站协议栈 (SSC)。
    *   **功能**: 允许网关被当作一个 IO 模块挂载到倍福 (Beckhoff) 或欧姆龙 PLC 下，同时“旁路”监听数据上传 MQTT。

### 2.2 边缘计算与逻辑处理（本地智能）
仅仅透传数据是不够的，边缘网关需要具备本地处理能力。

*   **数据清洗与聚合**
    *   **功能**: 设置死区（变化超过一定阈值才上传）、数据平滑滤波、多传感器数据融合。
    *   **优势**: 减少 MQTT 带宽占用，降低云端负载。
*   **本地规则引擎**
    *   **功能**: 实现简单的 IF-THIS-THEN-THAT 逻辑。例如：“如果 温度 > 80℃ (ADC采集)，则 停止电机 (PWM输出) 并 触发报警 (MQTT发布)”。
    *   **实现**: 轻量级脚本引擎（如 PikaScript 或 MicroPython）或 JSON 配置规则。
*   **断点续传 (Data Caching)**
    *   **利用硬件**: 外部 Flash/SDRAM
    *   **功能**: 当 MQTT 网络断开时，将数据存储在本地 Flash 中；网络恢复后自动补传。KawaiiMQTT 已具备部分能力，需结合文件系统完善。

### 2.3 北向接口（云端对接与服务）
除了现有的 MQTT，还需要支持更多 IT 标准。

*   **MQTT 增强**
    *   **功能**: 启用 TLS/SSL 加密连接（利用 mbedtls），支持 X.509 证书认证，确保数据安全。
    *   **数据模型**: 定义标准的 JSON 数据格式（如物模型 TSL），包含时间戳、质量戳。
*   **Web 配置界面**
    *   **实现**: 嵌入轻量级 Web 服务器 (WebNet)。
    *   **功能**: 允许用户通过浏览器配置 MQTT 服务器地址、串口波特率、采集周期等，无需重新烧录固件。

### 2.4 工业级可靠性与 TSN 特性
这是区分普通网关与高端工业网关的关键。

*   **TSN 时间同步 (IEEE 802.1AS)**
    *   **目标**: 实现网关与网络中其他设备的时间同步精度达到微秒级。
    *   **应用**: 为采集的数据打上精确的全局统一时间戳，便于云端进行时序分析。
*   **看门狗与系统监控**
    *   **利用硬件**: WDT
    *   **功能**: 建立任务级看门狗，监控 MQTT 线程、采集线程的存活状态。

---

## 3. 建议开发阶段

### 第一阶段：基础协议转换（当前重点）
1.  **Modbus RTU 适配**: 利用 UART 接口，实现读取一个外部 Modbus 从站数据，并通过 MQTT 发送。
2.  **CAN 通信测试**: 打通 CAN 接口，实现数据的收发。
3.  **JSON 格式规范化**: 优化 MQTT payload，使用 cJSON 库打包结构化数据。

### 第二阶段：边缘计算与存储
1.  **文件系统挂载**: 挂载 Flash 文件系统 (LittleFS/FatFS)。
2.  **离线缓存**: 修改 MQTT 发送逻辑，发送失败写入文件，连接成功读取文件发送。
3.  **Web 配置**: 移植 WebNet，实现网页配置 IP 和 MQTT 参数。

### 第三阶段：高级工业特性
1.  **TSN 探索**: 开启以太网控制器的 TSN 功能，测试 PTP 时间同步。
2.  **EtherCAT 接入**: 调试 EtherCAT 从站协议栈。
3.  **安全加固**: 启用 TLS 加密。

---

## 4. 总结
利用 R52 的高主频和 ECC 特性，该网关不仅能作为数据透传管道，更能成为一个**高可靠的边缘计算节点**。建议优先从 **Modbus/CAN 数据采集 -> MQTT 上报** 这一链路打通开始，逐步添加本地存储和 Web 配置功能。
